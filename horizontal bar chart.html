<!doctype html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>La Planche à Repasser</title>
    <link href="css/singlePageTemplate.css" rel="stylesheet" type="text/css">
    <link href="css/bootstrap.css" rel="stylesheet" type="text/css">
    <!--The following script tag downloads a font from the Adobe Edge Web Fonts server for use within the web page. We recommend that you do not modify it.-->
    <script>var __adobewebfontsappname__ = "dreamweaver"</script>
    <script src="http://use.edgefonts.net/source-sans-pro:n2:default.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.0/d3.min.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <style>
        .toolTip {
            position: absolute;
            display: none;
            min-width: 80px;
            height: auto;
            background: none repeat scroll 0 0 #ffffff;
            border: 1px solid #6F257F;
            padding: 14px;
            text-align: center;
        }
    </style>
<body>
<div class="container" style="text-align: center">
    <H1>La Planche à Repasser</H1>

    <div class="container" style="text-align: center">
        <h2>Barchart</h2>

        <div class="row">
            <div class="col-xs-4">
                <svg width="300" height="300" id="barchart2000"></svg>
            </div>
            <div class="col-xs-4">
                <svg width="300" height="300" id="barchart1980"></svg>
            </div>
            <div class="col-xs-4">
                <svg width="300" height="300" id="barchart1960"></svg>
            </div>
        </div>
    </div>
</div>

</body>
<script>
    function barchart() {


        var tooltip = d3.select("body").append("div").attr("class", "toolTip");


        var y_key = "count";


        d3.csv("movie_IMDB.csv", function (error, data) {
            if (error) throw error;

            data = data.filter(function (d) {
                var genres = d.genres.split("|");
                is_sf = false;
                genres.forEach(function (g) {
                    if (g === "Sci-Fi") {
                        is_sf = true;
                    }
                });
                return is_sf;
            });

            var date_format = d3.timeParse("%Y");
            data.forEach(function (d, i) {
                d.title_year = date_format(d.title_year);
            });
            // Filter years
            data = data.filter(function (d) {
                if (d.title_year) {
                    return +d.title_year.getFullYear() > 1960;
                } else {
                    return false;
                }
            });
            console.log(data);
            var nested = d3.nest()
                .key(function (d) {
                    if (d.title_year) {
                        return Math.floor(d.title_year.getFullYear() / 20) * 20;
                    } else {
                        return "nodate";
                    }
                })
                .key(function (d) {
                    return d.director_name;
                })

                .rollup(function (leaves) {
                    return {
                        'count': leaves.length,
                        //'total': d3.sum(leaves, function (d) {
                        //return (d.director_name);
                        //}),
                        'total_budget': d3.sum(leaves, function (d) {
                            return (d.budget);

                        }),
                        'avg_note': d3.mean(leaves, function (d) {
                            return (+d.imdb_score);
                        }),
                        'total_gross': d3.sum(leaves, function (d) {
                            return (d.gross);
                        }),
                        'films': leaves.map(function (d) {
                            return d.movie_title
                        })
                    }
                })
                .entries(data);

            nested.forEach(function (n) {
                console.log(n);
                n.values.sort(function (a, b) {
                    return d3.descending(a.value[y_key], b.value[y_key])
                });
            });

            console.log(nested);

            var color = d3.scaleOrdinal(d3.schemeCategory20);

            nested.forEach(function (nested_year) {

                var svg = d3.select("#barchart" + nested_year.key),
                    margin = {top: 20, right: 20, bottom: 30, left: 80},
                    width = +svg.attr("width") - margin.left - margin.right,
                    height = +svg.attr("height") - margin.top - margin.bottom;

                var g = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var x = d3.scaleLinear().range([0, width]);
                var y = d3.scaleBand().range([height, 0]);


                nested_year.values = nested_year.values.slice(0, 5);
                y.domain([4, 3, 2, 1, 0]).padding(0.1);
                x.domain([0, d3.max(nested_year.values, function (d) {
                    return d.value[y_key];
                })]).nice();


                console.log(nested_year);
                var tformat = d3.format(".0s");
                g.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).ticks(3).tickFormat(function (d) {
                        return tformat(+d);
                    }).tickSizeInner([-height]));

                g.append("g")
                    .attr("class", "y axis")
                    //.call(d3.axisLeft(y));

                g.selectAll(".bar")
                    .data(nested_year.values)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", 0)
                    .attr("fill", function(d){
                        return color(d.key)
                    })
                    .attr("height", y.bandwidth())
                    .attr("y", function (d, i) {
                        console.log(i);
                        return y(i);
                    })
                    .attr("width", function (d) {
                        return x(d.value[y_key]);
                    })
                    .on("mousemove", function (d) {
                        tooltip
                            .style("left", d3.event.pageX - 50 + "px")
                            .style("top", d3.event.pageY - 70 + "px")
                            .style("display", "inline-block")
                            .html(d.key + "<br>" + "" + tformat(d.value[y_key]) + "$");
                    })
                    .on("mouseout", function (d) {
                        tooltip.style("display", "none");
                    });
            })

        });
    }

    barchart();
</script>
</html>
